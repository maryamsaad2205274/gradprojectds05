{% extends "base.html" %}
{% block title %}Case History{% endblock %}

{% block content %}

<div class="h-head">
  <div>
    <h1 class="h-title">Case History</h1>
    <p class="h-sub">View your submitted analyses and open results.</p>
  </div>

  <div class="h-actions">
    <a class="btn btn--primary" href="{{ url_for('new_analysis') }}">+ New Analysis</a>
  </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="messages">
      {% for category, msg in messages %}
        <div class="msg {{ category }}">{{ msg }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="panel">
  <div class="panel__head">
    <div>
      <h2 class="panel__title">All Cases</h2>
      <p class="panel__sub">Latest cases first.</p>
    </div>
    <div class="t-muted">
      {{ cases|length if cases else 0 }} cases
    </div>
  </div>

  {% if cases and cases|length > 0 %}
    <div class="h-table">

      <div class="h-table__head">
        <div>Case</div>
        <div>Patient</div>
        <div>Age</div>
        <div>Gender</div>
        <div>Status</div>
        <div>Created</div>
        <div class="t-right">Action</div>
      </div>

      {% for c in cases %}
        {% set p = c.patient if c.patient else None %}

        <div class="h-table__row">
          <div class="t-strong">#{{ c.id }}</div>

          <div>
            <div class="t-strong">
              {% if p and p.name %}{{ p.name }}{% else %}-{% endif %}
            </div>
            <div class="t-muted">
              {% if p and p.patient_code %}{{ p.patient_code }}{% else %}-{% endif %}
            </div>
          </div>

          <div class="t-muted">
            {% if p and p.age %}{{ p.age }}{% else %}-{% endif %}
          </div>

          <div class="t-muted">
            {% if p and p.gender %}{{ p.gender }}{% else %}-{% endif %}
          </div>

          <div>
            <span class="badge
              {% if c.status=='COMPLETED' %}badge--ok
              {% elif c.status=='PENDING' %}badge--warn
              {% else %}badge--bad{% endif %}">
              {{ c.status }}
            </span>
          </div>

          <div class="t-muted">{{ c.created_at.strftime("%Y-%m-%d %H:%M") }}</div>

          <div class="t-right">
            <a class="btn btn--ghost btn--small" href="{{ url_for('view_result', case_id=c.id) }}">Open</a>
            <a class="btn btn--primary btn--small" href="{{ url_for('download_report', case_id=c.id) }}">PDF</a>
          </div>
        </div>
      {% endfor %}

    </div>
  {% else %}
    <div class="empty">
      <div class="empty__title">No cases yet</div>
      <div class="empty__text">Create your first analysis to see it here.</div>
      <a class="btn btn--primary btn--small" href="{{ url_for('new_analysis') }}">+ New Analysis</a>
    </div>
  {% endif %}
</div>

{% endblock %}
